name: 'builds container images'
description: 'builds container images for backup scripts'

inputs:
  github_token:
    description: 'GitHub Token'
    required: true

  image_name:
    description: 'image name'
    default: ''

  image_tag:
    description: 'image tag, if empty, will be generated from branch or tag'
    default: ''

  cachix_enabled:
    description: "cachix enabled"
    default: "false"

  cachix_cache_name:
    description: "cachix cache name"
    default: "kloudlite"

  cachix_auth_token:
    description: "cachix auth token"

  docker_enabled:
    description: "dokcer enabled"
    default: "false"

  git_directory:
    description: 'git directory'
    default: "."

  # Backup Scripts docker builds
  etcd:
    description: 'builds etcd backup script image'
    default: false

  mongodb:
    description: 'builds mongodb backup script image'
    default: false

  nats:
    description: 'builds nats backup script image'
    default: false

runs:
  using: 'composite'
  steps:
    - name: setup ENV Variables
      shell: bash
      id: env-vars
      working-directory: ${{ inputs.git_directory }}
      run: |+
        echo "PUSH_IMAGE=false" >> $GITHUB_ENV
        echo "IMAGE_NAME=${{inputs.image_name}}" >> $GITHUB_ENV

    - name: setup nix (with cachix)
      if: ${{ inputs.cachix_enabled == 'true' }}
      # uses: nxtcoder17/actions/setup-nix-cachix@main
      uses: nxtcoder17/actions/.github/actions/setup-nix-cachix@main
      with:
        flake_lock: ${{ inputs.git_directory }}/flake.lock
        nix_develop_arguments: "${{ inputs.git_directory }}#default"

        cachix_cache_name: ${{ inputs.cachix_cache_name }}
        cachix_auth_token: ${{ inputs.cachix_auth_token }}

    - name: setup nix cache (with github cache)
      if: ${{ inputs.cachix_enabled == 'false' }}
      # uses: nxtcoder17/actions/setup-nix-github@main
      uses: nxtcoder17/actions/.github/actions/setup-nix-github@main
      with:
        flake_lock: ${{ inputs.git_directory }}/flake.lock
        nix_develop_arguments: "${{ inputs.git_directory }}#default"

    - name: setup docker
      if: ${{ inputs.docker_enabled == 'true' }}
      # uses: nxtcoder17/actions/setup-docker@main
      uses: nxtcoder17/actions/.github/actions/setup-docker@main
      with:
        docker_username: ${{ github.actor }}
        docker_password: ${{ inputs.github_token }}

    - name: check if image needs to be pushed
      if: github.event_name != 'pull_request'
      shell: bash
      run: |+
        echo "PUSH_IMAGE=true" >> $GITHUB_ENV

    - name: Create Image Tag
      if: ${{ inputs.image_tag != '' }}
      shell: bash
      run: |+
        echo "IMAGE_TAG=${{ inputs.image_tag }}" >> $GITHUB_ENV

    - name: Create Image Tag from branch name / tags
      if: ${{ inputs.image_tag == '' }}
      # uses: nxtcoder17/actions/generate-image-tag@main
      uses: nxtcoder17/actions/.github/actions/generate-image-tag@main

    - name: etcd backup script
      if: ${{ inputs.etcd == 'true' }}
      working-directory: ${{ inputs.git_directory }}/k3s-etcd
      shell: bash
      run: |
        task k3s-etcd image=$IMAGE_NAME:{{.IMAGE_TAG}}

    - name: mongodb backup script
      if: ${{ inputs.mongodb == 'true' }}
      working-directory: ${{ inputs.git_directory }}/mongodb
      shell: bash
      run: |
        task mongodb-backup image=$IMAGE_NAME:$IMAGE_TAG

    - name: nats backup script
      if: ${{ inputs.nats == 'true' }}
      working-directory: ${{ inputs.git_directory }}/nats
      shell: bash
      run: |
        task nats-backup image=$IMAGE_NAME:$IMAGE_TAG
